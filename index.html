<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deriv Live Market</title>
</head>
<body>
  <h1>Deriv Login & Market Feed</h1>
  <button onclick="login()">Login with Deriv</button>
  <div id="account"></div>
  <div id="markets"></div>

  <script>
    function login() {
      const appId = 64585;
      const redirectUri = 'https://hirammureithi.github.io/deriv-login/';
      window.location.href = `https://oauth.deriv.com/oauth2/authorize?app_id=${appId}&redirect_uri=${redirectUri}`;
    }

    const symbols = [
      'R_10', 'R_25', 'R_50', 'R_75', 'R_100',
      '1HZ10V', '1HZ25V', '1HZ50V', '1HZ75V', '1HZ100V',
      'WS10', 'WS25', 'WS30', 'WS50', 'WS75', 'WS100'
    ];

    const urlHash = window.location.hash;
    const tokenMatch = urlHash.match(/access_token=([^&]+)/);

    if (tokenMatch) {
      const accessToken = tokenMatch[1];
      const accountDiv = document.getElementById("account");
      const marketsDiv = document.getElementById("markets");

      const ws = new WebSocket("wss://ws.deriv.com/websockets/v3?app_id=64585");

      ws.onopen = () => {
        ws.send(JSON.stringify({ authorize: accessToken }));
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        if (data.msg_type === "authorize") {
          accountDiv.innerHTML = `<p>Logged in as: ${data.authorize.loginid}</p>`;
          // Subscribe to all symbols
          symbols.forEach(symbol => {
            ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
            marketsDiv.innerHTML += `<div id="${symbol}">${symbol}: Loading...</div>`;
          });
        }

        if (data.msg_type === "tick") {
          const symbol = data.tick.symbol;
          const price = data.tick.quote;
          const element = document.getElementById(symbol);
          if (element) {
            element.textContent = `${symbol}: ${price}`;
          }
        }
      };
    }
  </script>
</body>
</html>
